<!DOCTYPE html>
<html>
<head>
    <title>Mobile Verification Debug</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .success { background: #d4edda; }
        .warning { background: #fff3cd; }
        .error { background: #f8d7da; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        pre { background: #f4f4f4; padding: 10px; overflow-x: auto; white-space: pre-wrap; }
        .highlight { background-color: yellow; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Mobile Verification Debug Tool</h1>
    
    <div class="section">
        <h2>Test Controls</h2>
        <button onclick="login()">1. Login as buyer@test.com</button>
        <button onclick="checkStrigaUser()">2. Check Striga User</button>
        <button onclick="checkKycStatus()">3. Check KYC Status</button>
        <button onclick="checkDashboard()">4. Check Dashboard View</button>
    </div>
    
    <div id="results"></div>
    
    <script>
        const baseUrl = 'http://155.138.165.47:3018';
        let cookies = '';
        
        function log(title, data, type = '') {
            const section = document.createElement('div');
            section.className = `section ${type}`;
            section.innerHTML = `<h3>${title}</h3><pre>${JSON.stringify(data, null, 2)}</pre>`;
            
            // Highlight phone verification fields
            section.innerHTML = section.innerHTML.replace(
                /(phoneVerified|mobileVerified|mobile_verification).*?(true|false)/g,
                '<span class="highlight">$&</span>'
            );
            
            document.getElementById('results').appendChild(section);
        }
        
        async function login() {
            document.getElementById('results').innerHTML = '';
            
            try {
                // Get CSRF
                const csrfRes = await fetch(`${baseUrl}/api/auth/csrf`);
                const { csrfToken } = await csrfRes.json();
                
                // Login
                const formData = new URLSearchParams({
                    email: 'buyer@test.com',
                    password: 'C@rlos2025',
                    csrfToken: csrfToken,
                    json: 'true'
                });
                
                const loginRes = await fetch(`${baseUrl}/api/auth/callback/credentials`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData.toString(),
                    credentials: 'include'
                });
                
                if (loginRes.ok || loginRes.status === 302) {
                    log('Login Success', { status: loginRes.status }, 'success');
                    
                    // Check session
                    const sessionRes = await fetch(`${baseUrl}/api/auth/session`, { credentials: 'include' });
                    const session = await sessionRes.json();
                    log('Session Data', session, session.user ? 'success' : 'error');
                } else {
                    log('Login Failed', { status: loginRes.status }, 'error');
                }
            } catch (error) {
                log('Login Error', { error: error.message }, 'error');
            }
        }
        
        async function checkStrigaUser() {
            try {
                const res = await fetch(`${baseUrl}/api/kyc/check-striga-user`, { credentials: 'include' });
                const data = await res.json();
                
                log('Striga User Check Response', data, res.ok ? 'success' : 'error');
                
                if (data.strigaUser) {
                    log('Striga KYC Data', data.strigaUser.KYC, 'warning');
                }
            } catch (error) {
                log('Check Striga User Error', { error: error.message }, 'error');
            }
        }
        
        async function checkKycStatus() {
            try {
                const res = await fetch(`${baseUrl}/api/kyc/status`, { credentials: 'include' });
                const data = await res.json();
                
                log('KYC Status Response', data, res.ok ? 'success' : 'error');
                
                // Analyze the response
                if (res.ok) {
                    const analysis = {
                        stage: data.stage,
                        emailVerified: data.emailVerified,
                        phoneVerified: data.phoneVerified,
                        kycStatus: data.kycStatus,
                        issue: data.stage === 'mobile_verification' && data.phoneVerified === true 
                            ? '⚠️ Phone is verified but stage is still mobile_verification!' 
                            : 'No issue detected'
                    };
                    log('Analysis', analysis, analysis.issue.includes('⚠️') ? 'warning' : 'success');
                }
            } catch (error) {
                log('Check KYC Status Error', { error: error.message }, 'error');
            }
        }
        
        async function checkDashboard() {
            try {
                // Simulate what the dashboard sees
                const res = await fetch(`${baseUrl}/api/auth/session`, { credentials: 'include' });
                const session = await res.json();
                
                if (session.user) {
                    log('Dashboard would see (from session)', {
                        role: session.user.role,
                        kycStatus: session.user.kycStatus,
                        strigaUserId: session.user.strigaUserId
                    }, 'warning');
                    
                    // Now check what live KYC check returns
                    const kycRes = await fetch(`${baseUrl}/api/kyc/status`, { credentials: 'include' });
                    const kycData = await kycRes.json();
                    
                    log('Dashboard KYC fetch result', {
                        stage: kycData.stage,
                        phoneVerified: kycData.phoneVerified,
                        wouldShowMobileVerificationPrompt: kycData.stage === 'mobile_verification'
                    }, kycData.stage === 'mobile_verification' ? 'error' : 'success');
                }
            } catch (error) {
                log('Dashboard Check Error', { error: error.message }, 'error');
            }
        }
    </script>
</body>
</html>